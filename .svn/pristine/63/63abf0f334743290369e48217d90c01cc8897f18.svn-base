import { Component, OnInit, EventEmitter,ViewEncapsulation,Inject } from '@angular/core';
import { MatDialog, MatDialogRef, MAT_DIALOG_DATA } from '@angular/material';
import { BusinessLogicService } from '../../../business-logic.service';
import { FileProperties,Inotification } from '../../../app.interface';
import {
  FormGroup,
  FormBuilder,
  Validators,
  FormControl
} from '@angular/forms';

@Component({
  selector: 'app-upload-popup',
  templateUrl: './upload-popup.component.html',
  styleUrls: ['./upload-popup.component.scss'],
  encapsulation: ViewEncapsulation.None
})
export class UploadPopupComponent implements OnInit {
  fileToUpload: File = null;
  fileBase: any;
  fileobject: FileProperties[] = [];
  file: any;
  fileCategory: any;
  sortBy: any;
  fileData = [[]];
  removable = true;
  onAdd = new EventEmitter();
  form: FormGroup;
  count = 0;
  categorySelection : string;
   sizeexceedsfilename : string = null;
   onlyimagewarning : string= null;
  constructor(private businesslogic: BusinessLogicService, public dialog: MatDialog,
    public dialogRef: MatDialogRef<UploadPopupComponent>, @Inject(MAT_DIALOG_DATA) public data: Inotification={name:null}, private formBuilder: FormBuilder ) {
      if(data.name == 'resources/getResourcesPolicies'){
           this.categorySelection = '1';
      }
      else{
        this.categorySelection = '2';
      }
     }

   
  ngOnInit() {
  //  this.selected = 1;
    this.form = this.formBuilder.group({
      fileCategory: [ 1, Validators.required],
      fileData: [null, Validators.required],
    });
  }

  onNoClick(): void {
    this.dialogRef.close();
  }

  changeListner(event) {
    console.log('event', event);
    const reader = new FileReader();
    reader.onload = (e: any) => { this.fileBase = e.target.result; };
    reader.readAsDataURL(event.target.files[0]);
  }

  openInput() {
    // your can use ElementRef for this later
    document.getElementById('upload').click();
  }

  onFileChange(evt) {
    this.count=0;
    this.fileobject = [];
    const files = evt.target.files;
    if(files.length > 5){
      this.onlyimagewarning = "Files Selection Limit Exceeds"
    }
else{
  for(let i=0;i<files.length;i++){
    if(files[i].type.indexOf("pdf")!=12 && files[i].type.indexOf("word")!=46){
      this.onlyimagewarning = "Accepts Only Word and Pdf files"
      this.count = 1;
      break;
    }
    else if(files[i].size>1000000){
      this.count=1;
      this.onlyimagewarning = null;
         this.sizeexceedsfilename = files[i].name;
         break;
    }
}
if(this.count==0){
  this.onlyimagewarning = null;
  this.sizeexceedsfilename = null;
    if (files) {
      for (let i = 0; i < files.length; i++) {
        this.file = files[i];
        const reader = new FileReader();
        reader.onload = this._handleReaderLoaded.bind(this, files.length, i, files[i]);
        reader.readAsBinaryString(this.file);
      }
    }
  }

  }
}
  

  _handleReaderLoaded(lengthoffiles, ivalue, filevalue, readerEvt) {

    const binaryString = readerEvt.target.result;
    this.fileobject.push({
      'fileName': filevalue.name, 'fileType': filevalue.type, 'files': btoa(binaryString),
      'updatedBy': 21375, 'createdBy': 21375, 'resourcesCategoryId': this.categorySelection
    });
    if (ivalue + 1 === lengthoffiles) {
      this.addfile();
    }
    // if (ivalue + 1 === lengthoffiles) {
    //   this.addimage();
    // }
  }

  addfile() {
    console.log(this.fileobject);

  }

  remove(image): void {
    const index = this.fileobject.indexOf(image);

    if (index >= 0) {
      this.fileobject.splice(index, 1);
    }
  }

  sendFile() {
    // tslint:disable-next-line:max-line-length
    this.businesslogic.post('resources/uploadFile', this.fileobject).subscribe((response: any) => {
      
      this.dialogRef.close({selectedcategoryyid : this.categorySelection,responsefromservice:response});
      
    });
   
  }

}
